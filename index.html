<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vagas Guich√™</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
    }
    
    .container { 
      max-width: 1400px;
      margin: 0 auto; 
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #1a5490 0%, #0d3a6b 100%);
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    .header h1 { 
      font-size: 32px; 
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .atualizado { 
      font-size: 14px; 
      opacity: 0.95;
      margin-top: 10px;
      font-weight: 500;
    }
    
    .config {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 3px solid #1a5490;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }
    
    .config-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .config-group label {
      font-weight: 600;
      font-size: 14px;
      color: #333;
    }
    
    .config input,
    .config select {
      padding: 12px;
      border: 2px solid #1a5490;
      border-radius: 8px;
      font-size: 16px;
      text-transform: uppercase;
      text-align: center;
      transition: all 0.3s;
    }
    
    .config input:focus,
    .config select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .rota-inputs {
      display: flex;
      gap: 8px;
    }
    
    .rota-inputs select {
      flex: 1;
    }
    
    .config button {
      padding: 14px 30px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .config button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    .config button:active {
      transform: translateY(0);
    }
    
    #statusNotif {
      grid-column: 1 / -1;
      text-align: center;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 18px;
    }
    
    .table-wrapper {
      overflow-x: auto;
      padding: 20px;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    th, td { 
      padding: 15px 12px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th { 
      background: linear-gradient(135deg, #1a5490 0%, #0d3a6b 100%);
      color: white;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tbody tr {
      transition: all 0.2s;
    }
    
    tbody tr:hover {
      background: #f5f5f5;
      transform: scale(1.01);
    }
    
    .minha-linha {
      background: #fff3cd !important;
      border-left: 5px solid #ff9800;
      font-weight: 600;
    }
    
    .minha-linha:hover {
      background: #ffe8a1 !important;
    }
    
    .vaga { 
      background: #333; 
      color: white; 
      font-weight: bold;
      font-size: 20px;
      border-radius: 5px;
    }
    
    .carregar { 
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      font-weight: bold;
      border-radius: 5px;
    }
    
    .patio { 
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      font-weight: bold;
      border-radius: 5px;
    }
    
    .alerta-rota {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 40px 60px;
      border-radius: 20px;
      font-size: 28px;
      font-weight: bold;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      z-index: 10000;
      text-align: center;
      animation: alertaPulse 0.5s ease-out;
    }
    
    @keyframes alertaPulse {
      from {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }
    
    .alerta-rota .btn-fechar {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      font-size: 28px;
      font-weight: bold;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .alerta-rota .btn-fechar:hover {
      background: rgba(255,255,255,0.5);
      transform: rotate(90deg);
    }
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
      max-width: 350px;
    }
    
    .toast {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 24px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      font-weight: 600;
      font-size: 16px;
      animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }
    
    .toast.vaga {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .toast.patio {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    }
    
    .toast.saindo {
      animation: slideOut 0.3s ease-in forwards;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    @media (min-width: 768px) {
      body {
        padding: 30px;
      }
      
      .header h1 {
        font-size: 42px;
      }
      
      .header {
        padding: 35px;
      }
      
      .config {
        padding: 30px;
        grid-template-columns: auto auto 1fr auto;
        gap: 20px;
      }
      
      #statusNotif {
        grid-column: 1 / -1;
      }
      
      .table-wrapper {
        padding: 30px;
      }
      
      th, td {
        padding: 18px 15px;
        font-size: 16px;
      }
      
      th {
        font-size: 15px;
      }
      
      .vaga {
        font-size: 24px;
      }
      
      .toast-container {
        max-width: 400px;
      }
      
      .toast {
        padding: 20px 28px;
        font-size: 18px;
      }
    }
    
    @media (max-width: 767px) {
      .header h1 {
        font-size: 24px;
      }
      
      .config {
        grid-template-columns: 1fr;
      }
      
      .config button {
        width: 100%;
      }
      
      th, td {
        padding: 10px 8px;
        font-size: 13px;
      }
      
      .vaga {
        font-size: 16px;
      }
      
      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      .toast {
        font-size: 14px;
        padding: 14px 18px;
      }
      
      .alerta-rota {
        padding: 30px 40px;
        font-size: 22px;
        max-width: 90%;
      }
    }
    
    @media (min-width: 1600px) {
      .header h1 {
        font-size: 48px;
      }
      
      th, td {
        padding: 20px 18px;
        font-size: 18px;
      }
      
      .vaga {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <div class="header">
      <h1>üöö Vagas Guich√™</h1>
      <div class="atualizado" id="atualizado">‚è≥ Conectando ao sistema...</div>
    </div>
    
    <div class="config">
      <div class="config-group">
        <label>Seu nome:</label>
        <input type="text" id="nomeInput" placeholder="Ex: Fulano" maxlength="20">
      </div>
      <div class="config-group">
        <label>Sua rota:</label>
        <div class="rota-inputs">
          <select id="letraSelect">
            <option value="">Letra</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="G">G</option>
            <option value="H">H</option>
            <option value="I">I</option>
            <option value="J">J</option>
            <option value="K">K</option>
            <option value="L">L</option>
            <option value="M">M</option>
            <option value="N">N</option>
            <option value="O">O</option>
            <option value="P">P</option>
            <option value="Q">Q</option>
            <option value="R">R</option>
            <option value="S">S</option>
            <option value="T">T</option>
            <option value="U">U</option>
            <option value="V">V</option>
            <option value="W">W</option>
            <option value="X">X</option>
            <option value="Y">Y</option>
            <option value="Z">Z</option>
          </select>
          <select id="numeroSelect">
            <option value="">N¬∫</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
            <option value="32">32</option>
            <option value="33">33</option>
            <option value="34">34</option>
            <option value="35">35</option>
            <option value="36">36</option>
            <option value="37">37</option>
            <option value="38">38</option>
            <option value="39">39</option>
            <option value="40">40</option>
            <option value="41">41</option>
            <option value="42">42</option>
            <option value="43">43</option>
            <option value="44">44</option>
            <option value="45">45</option>
            <option value="46">46</option>
            <option value="47">47</option>
            <option value="48">48</option>
            <option value="49">49</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
      <button onclick="salvar()" id="btnAtivar">üîî Ativar Notifica√ß√µes</button>
      <div id="statusNotif"></div>
    </div>
    
    <div id="conteudo" class="loading">
      <p>‚è≥ Carregando...</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDJBDzZCnjA0n-fm5PAhnMw2pbaUf8HLmU",
      authDomain: "vagas-ac041.firebaseapp.com",
      databaseURL: "https://vagas-ac041-default-rtdb.firebaseio.com",
      projectId: "vagas-ac041",
      storageBucket: "vagas-ac041.firebasestorage.app",
      messagingSenderId: "390077549191",
      appId: "1:390077549191:web:394bdbc4f65d67dcbb8622"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    let nome = localStorage.getItem('nome') || '';
    let rota = localStorage.getItem('rota') || '';
    let dadosAnteriores = [];
    let primeira = true;
    
    if (nome) {
      document.getElementById('nomeInput').value = nome;
    }
    
    const letraSalva = localStorage.getItem('letra');
    const numeroSalvo = localStorage.getItem('numero');
    if (letraSalva) document.getElementById('letraSelect').value = letraSalva;
    if (numeroSalvo) document.getElementById('numeroSelect').value = numeroSalvo;
    
    if (nome && rota) {
      const btn = document.getElementById('btnAtivar');
      const status = document.getElementById('statusNotif');
      
      btn.textContent = '‚úÖ Notifica√ß√µes Ativas';
      btn.style.background = '#2196F3';
      
      status.innerHTML = `<span style="color: #4CAF50; font-weight: bold;">üîî Ativo para ${nome} - Rota ${rota}<br>üì± Tela permanecer√° ligada</span>`;
      status.style.display = 'block';
    }
    
    function mostrarToast(rota, mensagem, tipo = '') {
      const container = document.getElementById('toastContainer');
      
      const toast = document.createElement('div');
      toast.className = `toast ${tipo}`;
      toast.innerHTML = `<strong>${rota}</strong> ‚Üí ${mensagem}`;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('saindo');
        setTimeout(() => toast.remove(), 300);
      }, 4000); 
    }
    
    window.salvar = async function() {
      nome = document.getElementById('nomeInput').value.trim();
      const letra = document.getElementById('letraSelect').value;
      const numero = document.getElementById('numeroSelect').value;
      
      if (!nome) {
        alert('‚ö†Ô∏è Digite seu nome!');
        return;
      }
      
      if (!letra || !numero) {
        alert('‚ö†Ô∏è Selecione letra e n√∫mero da sua rota!');
        return;
      }
      
      rota = `${letra}-${numero}`;
      
      localStorage.setItem('nome', nome);
      localStorage.setItem('rota', rota);
      localStorage.setItem('letra', letra);
      localStorage.setItem('numero', numero);
      
      if ("Notification" in window) {
        await Notification.requestPermission();
      }
      
      let wakeLock = null;
      
      const requestWakeLock = async () => {
        try {
          if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('‚úÖ Tela permanecer√° ligada');
          }
        } catch (err) {
          console.log('Wake Lock n√£o suportado:', err);
        }
      };
      
      await requestWakeLock();
      
      document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
          await requestWakeLock();
        }
      });
      
      const btn = document.getElementById('btnAtivar');
      const status = document.getElementById('statusNotif');
      
      btn.textContent = '‚úÖ Notifica√ß√µes Ativas';
      btn.style.background = '#2196F3';
      
      status.innerHTML = `<span style="color: #4CAF50; font-weight: bold;">üîî Ativo para ${nome} - Rota ${rota}<br>üì± Tela permanecer√° ligada</span>`;
      status.style.display = 'block';
      
      alert(`‚úÖ ${nome}, notifica√ß√µes ativadas para rota ${rota}!\nüì± Tela ficar√° ligada.`);
      primeira = true;
    }
    
    function alerta(msg) {
      const div = document.createElement('div');
      div.className = 'alerta-rota';
      
      const btnFechar = document.createElement('button');
      btnFechar.className = 'btn-fechar';
      btnFechar.innerHTML = '√ó';
      btnFechar.onclick = () => div.remove();
      
      div.innerHTML = msg;
      div.appendChild(btnFechar);
      document.body.appendChild(div);
    }
    
    function notificar(tipo, vaga) {
      let titulo, corpo, textoVoz, mensagemAlerta;
      
      if (tipo === 'patio') {
        titulo = `üìç ${nome}!`;
        corpo = `Rota ${rota} ENTRAR NO P√ÅTIO`;
        textoVoz = `${nome}! Rota ${rota}. Entrar no p√°tio!`;
        mensagemAlerta = `üìç ${nome}!<br>Rota ${rota}<br>ENTRAR NO P√ÅTIO`;
      } else if (tipo === 'vaga') {
        titulo = `üéØ ${nome}!`;
        corpo = `Rota ${rota} VAGA ${vaga} PODE CARREGAR!`;
        textoVoz = `${nome}! Rota ${rota}. Vaga ${vaga}. Pode carregar!`;
        mensagemAlerta = `üéØ ${nome}!<br>Rota ${rota}<br>VAGA ${vaga}<br>PODE CARREGAR!`;
      }
      
      if ('speechSynthesis' in window) {
        const speech = new SpeechSynthesisUtterance(textoVoz);
        speech.lang = 'pt-BR';
        speech.rate = 0.9;
        speech.pitch = 1.2;
        speech.volume = 1.0;
        
        speech.onend = () => {
          setTimeout(() => {
            const speech2 = new SpeechSynthesisUtterance(textoVoz);
            speech2.lang = 'pt-BR';
            speech2.rate = 0.9;
            speech2.pitch = 1.2;
            speech2.volume = 1.0;
            window.speechSynthesis.speak(speech2);
          }, 500);
        };
        
        window.speechSynthesis.speak(speech);
      }
      
      setTimeout(() => {
        if (Notification.permission === "granted") {
          try {
            const notification = new Notification(titulo, {
              body: corpo,
              icon: '/icon-192.png',
              badge: '/icon-192.png',
              tag: `${tipo}-${rota}`,
              requireInteraction: true,
              vibrate: [200, 100, 200, 100, 200, 100, 200]
            });
            
            notification.onclick = function() {
              window.focus();
              this.close();
            };
          } catch (err) {
            console.error('Erro notifica√ß√£o:', err);
          }
        }
      }, 100);
      
      alerta(mensagemAlerta);
    }
    
    function processar(json) {
      try {
        if (!json || !json.data || json.data.length < 4) {
          const mensagem = `<div class="loading">
            <p style="font-size: 48px; margin-bottom: 15px;">üåô</p>
            <p style="font-size: 20px; font-weight: bold; color: #1a5490;">Opera√ß√µes encerradas hoje</p>
            <p style="font-size: 16px; color: #666; margin-top: 10px;">Todas as rotas foram finalizadas.<br><strong>Sistema retorna amanh√£ √†s 4:30 da manh√£.</strong></p>
            <p style="font-size: 14px; color: #999; margin-top: 15px;">Bom descanso! üò¥</p>
          </div>`;
          
          document.getElementById('conteudo').innerHTML = mensagem;
          document.getElementById('atualizado').innerHTML = 'üåô Encerrado';
          return;
        }
        
        const linhas = json.data;
        const novos = [];
        
        let html = '<table><tr><th>TURNO</th><th>ROTA</th><th>VAGA</th><th>STATUS</th><th>CHECK-IN</th></tr>';
        
        linhas.slice(3).forEach(linha => {
          if (!linha || !linha[1]) return;
          
          const [turno, , r, v, s, checkin] = linha;
          const chave = `${turno}-${r}`;
          const ant = dadosAnteriores.find(d => d.chave === chave);
          const ehMinha = rota && r && r.toUpperCase() === rota;
          
          if (!primeira && ant) {
            if (s && s.includes('p√°tio') && (!ant.status || !ant.status.includes('p√°tio'))) {
              mostrarToast(r, 'Entrar no p√°tio', 'patio');
            }
            
            if (v && v !== '-' && ant.vaga !== v) {
              mostrarToast(r, `Vaga ${v}`, 'vaga');
            }
          }
          
          if (ehMinha && !primeira && ant) {
            if (s && s.includes('p√°tio') && (!ant.status || !ant.status.includes('p√°tio'))) {
              notificar('patio');
            }
            
            if (v && v !== '-' && ant.vaga !== v) {
              notificar('vaga', v);
            }
          }
          
          novos.push({ chave, vaga: v, status: s });
          
          let cls = '';
          if (s && s.includes('Carregar')) cls = 'carregar';
          else if (s && s.includes('p√°tio')) cls = 'patio';
          
          html += `<tr class="${ehMinha ? 'minha-linha' : ''}">
            <td>${turno || ''}</td>
            <td><strong>${r || ''}</strong></td>
            <td class="vaga">${v || '-'}</td>
            <td class="${cls}">${s || ''}</td>
            <td>${checkin === 'TRUE' ? '‚úÖ' : checkin === 'FALSE' ? '‚ùå' : ''}</td>
          </tr>`;
        });
        
        html += '</table>';
        document.getElementById('conteudo').innerHTML = html;
        
        dadosAnteriores = novos;
        primeira = false;
        
        const agora = new Date(json.lastUpdate).toLocaleString('pt-BR');
        const estadoTexto = json.estadoSistema || '';
        let estadoEmoji = '';
        
        if (estadoTexto.includes('ATIVO')) {
          estadoEmoji = 'üü¢ Operando';
        } else if (estadoTexto === 'AGUARDANDO_AM') {
          estadoEmoji = '‚è≥ Aguardando AM';
        } else if (estadoTexto === 'AM_COMPLETO') {
          estadoEmoji = '‚òï Intervalo';
        } else if (estadoTexto === 'ENCERRADO' || estadoTexto === 'PM_COMPLETO') {
          estadoEmoji = 'üåô Encerrado';
        } else {
          estadoEmoji = '‚è∏Ô∏è Standby';
        }
        
        document.getElementById('atualizado').innerHTML = `${estadoEmoji} ‚Ä¢ Atualizado: ${agora}`;
      } catch (erro) {
        document.getElementById('conteudo').innerHTML = 
          '<div class="loading"><p>‚ùå Erro: ' + erro.message + '</p></div>';
        console.error(erro);
      }
    }
    
    // FIREBASE REALTIME - Escuta mudan√ßas em tempo real
    const vagasRef = ref(database, 'vagas');
    onValue(vagasRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        processar(data);
      }
    });
  </script>
</body>
</html>
